
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="AWS Controllers for Kubernetes">
      
      
      
        <meta name="author" content="The ACK contributors">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.0.1">
    
    
      
        <title>Testing - ACK</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.38780c08.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f72e892.min.css">
        
          
          
          <meta name="theme-color" content="#ffa724">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oxygen:300,400,400i,700%7COxygen+Mono&display=fallback">
        <style>body,input{font-family:"Oxygen",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Oxygen Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="orange" data-md-color-accent="">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="ACK" class="md-header-nav__button md-logo" aria-label="ACK">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            ACK
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Testing
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws/aws-controllers-k8s/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-controllers-k8s
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ACK" class="md-nav__button md-logo" aria-label="ACK">
      
  <img src="../../assets/images/logo.png" alt="logo">

    </a>
    ACK
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws/aws-controllers-k8s/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-controllers-k8s
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Home" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../services/" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      User docs
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="User docs" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        User docs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-docs/wip/" title="Install" class="md-nav__link">
      Install
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-docs/wip/" title="Permissions" class="md-nav__link">
      Permissions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-docs/wip/" title="Usage" class="md-nav__link">
      Usage
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Contributor docs
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Contributor docs" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Contributor docs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code-generation/" title="Code generation" class="md-nav__link">
      Code generation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Testing
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Testing" class="md-nav__link md-nav__link--active">
      Testing
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-code-generator" class="md-nav__link">
    Build code generator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-an-ack-service-controller" class="md-nav__link">
    Build an ACK service controller
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-tests" class="md-nav__link">
    Run tests
  </a>
  
    <nav class="md-nav" aria-label="Run tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam-setup" class="md-nav__link">
    IAM setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-end-to-end-test" class="md-nav__link">
    Run end-to-end test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clean-up" class="md-nav__link">
    Clean up
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Community
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Community" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Community
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../community/background/" title="Background" class="md-nav__link">
      Background
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../community/faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../community/discussions/" title="Discussions" class="md-nav__link">
      Discussions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/aws/aws-controllers-k8s/blob/master/CONTRIBUTING.md" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://github.com/aws/aws-controllers-k8s/blob/master/GOVERNANCE.md" title="Governance" class="md-nav__link">
      Governance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-code-generator" class="md-nav__link">
    Build code generator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-an-ack-service-controller" class="md-nav__link">
    Build an ACK service controller
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-tests" class="md-nav__link">
    Run tests
  </a>
  
    <nav class="md-nav" aria-label="Run tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam-setup" class="md-nav__link">
    IAM setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-end-to-end-test" class="md-nav__link">
    Run end-to-end test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clean-up" class="md-nav__link">
    Clean up
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws/aws-controllers-k8s/edit/master/docs/dev-docs/testing.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h1>
<p>Welcome to the ACK developer preview! In the following, we will take you
through the steps to test ACK for the currently supported AWS services:</p>
<ul>
<li>Amazon ECR</li>
<li>Amazon S3</li>
<li>Amazon SNS</li>
<li>Amazon API Gateway V2</li>
</ul>
<p>If you run into any problems when testing one of the above services,
<a href="https://github.com/aws/aws-controllers-k8s/issues/new/choose">raise an issue</a>
with the details so we can reproduce your issue.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<p>For local development and testing we use "Kubernetes in Docker" (<code>kind</code>), 
which in turn requires Docker.</p>
<div class="admonition warning">
<p class="admonition-title">Footprint</p>
<p>When you run the <code>scripts/kind-build-test.sh</code> script the first time,
the step that builds the container image for the target ACK service
controller can take up to 40 or more minutes. This is because the container image
contains a lot of dependencies. Once you successfully build the target
image this base image layer is cached locally, and the build takes a much 
shorter amount of time. We are aware of this (and the storage footprint,
ca. 3 GB) and aim to reduce both in the fullness of time.</p>
</div>
<p>In summary, in order to test ACK you will need to have the following tools
installed and configured:</p>
<ol>
<li><a href="https://docs.docker.com/get-docker/">Docker</a></li>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/">kind</a></li>
<li><a href="https://github.com/kubernetes-sigs/controller-tools">kubernetes-sigs/controller-tools</a></li>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv1.html">AWS CLI</a> version 1</li>
<li><a href="https://github.com/stedolan/jq/wiki/Installation">jq</a></li>
<li><code>make</code></li>
</ol>
<p>To build and test an ACK controller with <code>kind</code>, execute the commands as 
described in the following from the root directory of your
<a href="../setup/">checked-out source repository</a>.</p>
<div class="admonition tip">
<p class="admonition-title">Recommended RAM</p>
<p>Given that our test setup creates the container images and then launches
a test cluster, we recommend that you have at least 4GB of RAM available
for the tests.</p>
</div>
<p>With the prerequisites out of the way, let's move on to the first step:
building the code generator.</p>
<h2 id="build-code-generator">Build code generator<a class="headerlink" href="#build-code-generator" title="Permanent link">&para;</a></h2>
<p>To build the latest <code>ack-generate</code> binary, execute the following command:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">make build-ack-generate</span>
</code></pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">One-off build</p>
<p>You only have to do this once, overall. In other words: unless we change
something upstream in terms of the code generation process, this is 
a one-off operation. Internally, the Makefile executes an <code>go build</code> here.</p>
</div>
<p>Don't worry if you forget this step, the script in the next step will complain 
with a message along the line of <code>ERROR: Unable to find an ack-generate binary</code>
and will give you another opportunity to rectify the situation.</p>
<h2 id="build-an-ack-service-controller">Build an ACK service controller<a class="headerlink" href="#build-an-ack-service-controller" title="Permanent link">&para;</a></h2>
<p>Now that we have the basic code generation step done we will create the
respective ACK service controller and its supporting artifacts.</p>
<p>So first you have to select a service that you want to build and test.
You do that by setting the <code>SERVICE</code> environment variable. Let's say we want 
to test the S3 service (creating an S3 bucket), so we would execute the
following:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">export</span> <span class="n">SERVICE</span><span class="o">=</span><span class="n">s3</span>
</code></pre></div>
</td></tr></table>

<p>Now we are in a position to generate the ACK service controller for the S3 API.</p>
<p>The following outputs the generated code to the <code>services/$SERVICE</code> directory:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">make build-controller SERVICE=$SERVICE</span>
</code></pre></div>
</td></tr></table>

<div class="admonition bug">
<p class="admonition-title">Handle <code>controller-gen: command not found</code></p>
<p>If you run into the <code>controller-gen: command not found</code> message when
executing <code>make build-controller</code> then you want to check if the
<code>controller-gen</code> binary is available in <code>$GOPATH/bin</code>, see also
<a href="https://github.com/aws/aws-controllers-k8s/issues/234"><code>#234</code></a>.</p>
</div>
<p>In addition to the ACK service controller code, above generates the
custom resource definition (CRD) manifests as well as the necessary RBAC
settings using the <a href="https://github.com/aws/aws-controllers-k8s/blob/main/scripts/build-controller.sh"><code>build-controller.sh</code></a>
script.</p>
<div class="admonition note">
<p class="admonition-title">Beyond dev preview</p>
<p>In future, this step will also generate the end-user install artifacts, that
is the Helm chart etc. that can be used to install those CRD manifests, 
and a deployment manifest that runs the ACK service controller in a pod.</p>
</div>
<p>Now that we have the generation part completed, we want to see if the
generated artifacts indeed are able to create an S3 bucket for us.</p>
<p>You don't have to do the next steps, if all you want to test is if the
generation works, however, for an end-to-end test, the next, final step is
a necessary one.</p>
<h2 id="run-tests">Run tests<a class="headerlink" href="#run-tests" title="Permanent link">&para;</a></h2>
<p>Time to run the end-to-end test.</p>
<h3 id="iam-setup">IAM setup<a class="headerlink" href="#iam-setup" title="Permanent link">&para;</a></h3>
<p>In order for the ACK service controller to manage the S3 bucket, it needs an
identity. In other words, it needs an IAM role that represents the ACK service
controller towards the S3 service.</p>
<p>First, define the name of the IAM role that will have the permission to manage
S3 buckets on your behalf:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">export</span> <span class="n">ACK_TEST_IAM_ROLE</span><span class="o">=</span><span class="n">Admin</span><span class="o">-</span><span class="n">k8s</span>
</code></pre></div>
</td></tr></table>

<p>Now we need to verify the IAM principal (likely an IAM user) that is going to
assume the IAM role <code>ACK_TEST_IAM_ROLE</code>. So to get its ARN, execute:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="k">export</span> <span class="n">ACK_TEST_PRINCIPAL_ARN</span><span class="o">=$</span><span class="p">(</span><span class="n">aws</span> <span class="n">sts</span> <span class="n">get</span><span class="o">-</span><span class="n">caller</span><span class="o">-</span><span class="n">identity</span> <span class="o">--</span><span class="n">query</span> <span class="s1">&#39;Arn&#39;</span> <span class="o">--</span><span class="n">output</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>

<p>You can verify if that worked using <code>echo $ACK_TEST_PRINCIPAL_ARN</code> and that should
print something along the lines of <code>arn:aws:iam::1234567890121:user/ausername</code>.</p>
<p>Next up, create the IAM role, adding the necessary trust relationship to the role,
using the following commands:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">cat &gt; trust-policy.json &lt;&lt; EOF</span>
<span class="err">{</span>
<span class="err">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span>
<span class="err">    &quot;Statement&quot;: {</span>
<span class="err">        &quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="err">        &quot;Principal&quot;: {</span>
<span class="err">            &quot;AWS&quot;: &quot;$ACK_TEST_PRINCIPAL_ARN&quot;</span>
<span class="err">        },</span>
<span class="err">        &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span>
<span class="err">    }</span>
<span class="err">}</span>
<span class="err">EOF</span>
</code></pre></div>
</td></tr></table>

<p>Using above trust policy, we can now create the IAM role:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">aws iam create-role \</span>
<span class="err">    --role-name $ACK_TEST_IAM_ROLE \</span>
<span class="err">    --assume-role-policy-document file://trust-policy.json</span>
</code></pre></div>
</td></tr></table>

<p>Now we're in the position to give the IAM role <code>ACK_TEST_IAM_ROLE</code> the permission
to handle S3 buckets for us, using:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">aws iam attach-role-policy \</span>
<span class="err">    --role-name $ACK_TEST_IAM_ROLE \</span>
<span class="err">    --policy-arn &quot;arn:aws:iam::aws:policy/AmazonS3FullAccess&quot;</span>
</code></pre></div>
</td></tr></table>

<div class="admonition tip">
<p class="admonition-title">Access delegation in IAM</p>
<p>If you're not that familiar with IAM access delegation, we recommend you
to peruse the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html">IAM documentation</a></p>
</div>
<p>Next, in order for our test to generate <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html">temporary credentials</a>
we need to tell it to use the IAM role we created in the previous step.
To generate the IAM role ARN, do:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">AWS_ACCOUNT_ID</span><span class="o">=$</span><span class="p">(</span><span class="n">aws</span> <span class="n">sts</span> <span class="n">get</span><span class="o">-</span><span class="n">caller</span><span class="o">-</span><span class="n">identity</span> <span class="o">--</span><span class="n">query</span> <span class="s1">&#39;Account&#39;</span> <span class="o">--</span><span class="n">output</span> <span class="n">text</span><span class="p">)</span> <span class="o">&amp;&amp;</span> \
<span class="k">export</span> <span class="n">AWS_ROLE_ARN</span><span class="o">=</span><span class="n">arn</span><span class="p">:</span><span class="n">aws</span><span class="p">:</span><span class="n">iam</span><span class="p">::</span><span class="o">$</span><span class="p">{</span><span class="n">AWS_ACCOUNT_ID</span><span class="p">}:</span><span class="n">role</span><span class="o">/$</span><span class="p">{</span><span class="n">ACK_TEST_IAM_ROLE</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The tests uses the <code>generate_temp_creds</code> function from the
 <code>scripts/lib/aws.sh</code> script, executing effectively 
 <code>aws sts assume-role --role-session-arn $AWS_ROLE_ARN --role-session-name $TEMP_ROLE</code>
 which fetches temporarily <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>,
 and an <code>AWS_SESSION_TOKEN</code> used in turn to authentication the ACK
 controller. The duration of the session token is 900 seconds (15 minutes).</p>
</div>
<p>Phew that was a lot to set up, but good news: you're almost there.</p>
<h3 id="run-end-to-end-test">Run end-to-end test<a class="headerlink" href="#run-end-to-end-test" title="Permanent link">&para;</a></h3>
<p>Before you proceed, make sure that you've done the IAM setup in the previous
step.</p>
<div class="admonition warning">
<p class="admonition-title">IAM troubles?!</p>
<p>If you try the following command and you see an error message containing
something along the line of <code>AWS_ROLE_ARN is not defined.</code> then you know
that somewhere in the IAM setup you either left out a step or one of the
commands failed.</p>
</div>
<p>Now we're finally in the position to execute the end-to-end test:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">make kind-test SERVICE=$SERVICE</span>
</code></pre></div>
</td></tr></table>

<p>This provisions a Kubernetes cluster using <code>kind</code>, builds a container image with
the ACK service controller, and loads the container image into the <code>kind</code> cluster.</p>
<p>It then installs the ACK service controller and related Kubernetes manifests into
the <code>kind</code> cluster using <code>kustomize build | kubectl apply -f -</code>.</p>
<p>Then, the above script runs a series of test scripts that call <code>kubectl</code>
and the <code>aws</code> CLI tools to verify that custom resources of the type managed by
the respective ACK service controller is created, updated and deleted
appropriately (still TODO).</p>
<p>Finally, it will run tests that create resources for the respective service
and verify if the resource has successfully created. In our example case it
should create an S3 bucket and then destroy it again, yielding something like
the following (edited down to the relevant parts):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="o">...</span>
<span class="o">./</span><span class="n">scripts</span><span class="o">/</span><span class="n">kind</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">test</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">s</span> <span class="n">s3</span>
<span class="n">Using</span> <span class="n">Kubernetes</span> <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">16.9</span><span class="err">@</span><span class="n">sha256</span><span class="p">:</span><span class="mi">7175872357</span><span class="n">bc85847ec4b1aba46ed1d12fa054c83ac7a8a11f5c268957fd5765</span>
<span class="n">Creating</span> <span class="n">k8s</span> <span class="n">cluster</span> <span class="n">using</span> <span class="s2">&quot;kind&quot;</span> <span class="o">...</span>
<span class="n">No</span> <span class="n">kind</span> <span class="n">clusters</span> <span class="n">found</span><span class="o">.</span>
<span class="n">Created</span> <span class="n">k8s</span> <span class="n">cluster</span> <span class="n">using</span> <span class="s2">&quot;kind&quot;</span>
<span class="n">Building</span> <span class="n">s3</span> <span class="n">docker</span> <span class="n">image</span>
<span class="n">Building</span> <span class="s1">&#39;s3&#39;</span> <span class="n">controller</span> <span class="n">docker</span> <span class="n">image</span> <span class="n">with</span> <span class="n">tag</span><span class="p">:</span> <span class="n">ack</span><span class="o">-</span><span class="n">s3</span><span class="o">-</span><span class="n">controller</span><span class="p">:</span><span class="n">ec452ed</span>
<span class="n">sha256</span><span class="p">:</span><span class="n">c9cbcc028f2b7351d0507f8542ab88c80f9fb5a3b8b800feee8e362882833eef</span>
<span class="n">Loading</span> <span class="n">the</span> <span class="n">images</span> <span class="n">into</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="n">Image</span><span class="p">:</span> <span class="s2">&quot;ack-s3-controller:ec452ed&quot;</span> <span class="n">with</span> <span class="n">ID</span> <span class="s2">&quot;sha256:c9cbcc028f2b7351d0507f8542ab88c80f9fb5a3b8b800feee8e362882833eef&quot;</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">present</span> <span class="n">on</span> <span class="n">node</span> <span class="s2">&quot;test-ccc3c7f1-worker&quot;</span><span class="p">,</span> <span class="n">loading</span><span class="o">...</span>
<span class="n">Image</span><span class="p">:</span> <span class="s2">&quot;ack-s3-controller:ec452ed&quot;</span> <span class="n">with</span> <span class="n">ID</span> <span class="s2">&quot;sha256:c9cbcc028f2b7351d0507f8542ab88c80f9fb5a3b8b800feee8e362882833eef&quot;</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">present</span> <span class="n">on</span> <span class="n">node</span> <span class="s2">&quot;test-ccc3c7f1-control-plane&quot;</span><span class="p">,</span> <span class="n">loading</span><span class="o">...</span>
<span class="n">Loading</span> <span class="n">CRD</span> <span class="n">manifests</span> <span class="k">for</span> <span class="n">s3</span> <span class="n">into</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="n">customresourcedefinition</span><span class="o">.</span><span class="n">apiextensions</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">buckets</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">aws</span> <span class="n">created</span>
<span class="n">Loading</span> <span class="n">RBAC</span> <span class="n">manifests</span> <span class="k">for</span> <span class="n">s3</span> <span class="n">into</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="n">clusterrole</span><span class="o">.</span><span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ack</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">role</span> <span class="n">created</span>
<span class="n">clusterrolebinding</span><span class="o">.</span><span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ack</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">rolebinding</span> <span class="n">created</span>
<span class="n">Loading</span> <span class="n">service</span> <span class="n">controller</span> <span class="n">Deployment</span> <span class="k">for</span> <span class="n">s3</span> <span class="n">into</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="mi">2020</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">18</span> <span class="mi">09</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">46</span> <span class="n">Fixed</span> <span class="n">the</span> <span class="n">missing</span> <span class="n">field</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">apiVersion</span><span class="p">:</span> <span class="n">kustomize</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">Fixed</span> <span class="n">the</span> <span class="n">missing</span> <span class="n">field</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">kind</span><span class="p">:</span> <span class="n">Kustomization</span>
<span class="n">namespace</span><span class="o">/</span><span class="n">ack</span><span class="o">-</span><span class="n">system</span> <span class="n">created</span>
<span class="n">deployment</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">ack</span><span class="o">-</span><span class="n">s3</span><span class="o">-</span><span class="n">controller</span> <span class="n">created</span>
<span class="n">Running</span> <span class="n">aws</span> <span class="n">sts</span> <span class="n">assume</span><span class="o">-</span><span class="n">role</span> <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="p">:</span><span class="n">aws</span><span class="p">:</span><span class="n">iam</span><span class="p">::</span><span class="mi">1234567890121</span><span class="p">:</span><span class="n">role</span><span class="o">/</span><span class="n">Admin</span><span class="o">-</span><span class="n">k8s</span><span class="p">,</span> <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">name</span> <span class="n">tmp</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="mi">1</span><span class="n">b779de5</span>  <span class="o">--</span><span class="n">duration</span><span class="o">-</span><span class="n">seconds</span> <span class="mi">900</span><span class="p">,</span>
<span class="n">Temporary</span> <span class="n">credentials</span> <span class="n">generated</span>
<span class="n">deployment</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">ack</span><span class="o">-</span><span class="n">s3</span><span class="o">-</span><span class="n">controller</span> <span class="n">env</span> <span class="n">updated</span>
<span class="n">Added</span> <span class="n">AWS</span> <span class="n">Credentials</span> <span class="n">to</span> <span class="n">env</span> <span class="n">vars</span> <span class="n">map</span>
<span class="o">======================================================================================================</span>
<span class="n">To</span> <span class="n">poke</span> <span class="n">around</span> <span class="n">your</span> <span class="n">test</span> <span class="n">manually</span><span class="p">:</span>
<span class="k">export</span> <span class="n">KUBECONFIG</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">hausenbl</span><span class="o">/</span><span class="n">ACK</span><span class="o">/</span><span class="n">upstream</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">controllers</span><span class="o">-</span><span class="n">k8s</span><span class="o">/</span><span class="n">scripts</span><span class="o">/../</span><span class="n">build</span><span class="o">/</span><span class="n">tmp</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">ccc3c7f1</span><span class="o">/</span><span class="n">kubeconfig</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">A</span>
<span class="o">======================================================================================================</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">aws</span><span class="o">/</span><span class="n">ack</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">smoke</span><span class="o">-</span><span class="n">s3</span> <span class="n">created</span>
<span class="p">{</span>
  <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;ack-test-smoke-s3&quot;</span><span class="p">,</span>
  <span class="s2">&quot;CreationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2020-08-18T08:52:04+00:00&quot;</span>
<span class="p">}</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">aws</span> <span class="s2">&quot;ack-test-smoke-s3&quot;</span> <span class="n">deleted</span>
<span class="n">smoke</span> <span class="n">took</span> <span class="mi">27</span> <span class="n">second</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="err">🥑</span> <span class="n">Deleting</span> <span class="n">k8s</span> <span class="n">cluster</span> <span class="n">using</span> <span class="s2">&quot;kind&quot;</span>
<span class="n">Deleting</span> <span class="n">cluster</span> <span class="s2">&quot;test-ccc3c7f1&quot;</span> <span class="o">...</span>
</code></pre></div>
</td></tr></table>

<p>As you can see, in above case the end-to-end test (creating cluster, deploying
ACK, applying custom resources, and tear-down) took less than 30 seconds. This
is for the warmed caches case.</p>
<h3 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h3>
<p>We use <a href="https://github.com/vektra/mockery">mockery</a> for unit testing.
You can install it by following the guideline on mockery's GitHub or simply
by running our handy scirpt at <code>./scripts/install_mockery.sh</code> for general
Linux environments.</p>
<p>We track testing in the umbrella <a href="https://github.com/aws/aws-controllers-k8s/issues/6">issue 6</a>.
 on GitHub. Use this issue as a starting point and if you create a new
 testing-related issue, mention it from there.</p>
<h2 id="clean-up">Clean up<a class="headerlink" href="#clean-up" title="Permanent link">&para;</a></h2>
<p>To clean up a <code>kind</code> cluster, including the container images and configuration 
files created by the script specifically for said test cluster, execute:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kind delete cluster --name $CLUSTER_NAME</span>
</code></pre></div>
</td></tr></table>

<p>If you want to delete all <code>kind</code> cluster running on your machine, use: </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">make delete-all-kind-clusters</span>
</code></pre></div>
</td></tr></table>

<p>With this the testing is completed. Thanks for your time and we appreciate your
feedback.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../setup/" title="Setup" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Setup
              </div>
            </div>
          </a>
        
        
          <a href="../../community/background/" title="Background" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Background
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Amazon
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/awscloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.77e55a48.min.js"></script>
      <script src="../../assets/javascripts/bundle.aa3f9871.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['tabs', 'instant'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>